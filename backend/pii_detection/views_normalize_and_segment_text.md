# 文本标准化与LTP分词处理规则

## 概述
本文档详细说明了当前系统的文本处理流程，包括文本标准化和LTP分词两个主要阶段。

### 处理流程概览
1. **文本标准化** → 清理、规范化、分句 → 输出: `['句子1', '句子2', '句子3']`
2. **LTP分词** → 对每个句子分词 → 输出: `['词1', '词2']['词3', '词4']`
3. **自动保存** → JSON文件保存到容器内 `/backend/knowledge_base/text/`

---

## 文本标准化规则与示例

### 1) 基础字符与空白处理
- 规则：
  - 使用 NFKC 进行 Unicode 规范化（全角转半角等）。
  - 统一空白字符（中间过程用空格合并；最终每句内会移除多余空白）。
  - 换行符统一为 `\n`，随后按句子切分输出。
- 示例：
  - 输入：`４５ 岁\t\t 男\r\n` → 中间过程规范化 → 最终句内为紧凑文本（不保留空格），如 `45岁，男`。

### 2) 标点处理（仅保留逗号）
- 规则：
  - 清理重复标点：`！！！` → `！`，`？？` → `？`，`；；` → `；`。
  - 分句时保留句号/问号/感叹号/分号作为“分割符”，最终输出时移除这些句末标点。
  - 句内仅保留逗号，其余标点（括号、引号、方括号、冒号、顿号等）移除。
  - 英文逗号 `,` 统一为中文逗号 `，`。
- 示例：
  - 输入：`主诉头痛3天！！！曾诊断为高血压；现服用阿司匹林、布洛芬……` →
    `['主诉头痛3天', '曾诊断为高血压', '现服用阿司匹林布洛芬']`

### 3) 数字格式
- 规则：移除数字中的千分位逗号（例如 `1,234.56` → `1234.56`）。
- 示例：
  - 输入：`血糖 1,234.56 mg/dL` → `血糖1234.56mg/dL`

### 4) 日期标准化（YYYYMMDD）
- 规则：识别以下日期形式并统一为 `YYYYMMDD`：
  - `YYYY年M月D日/号`
  - `YYYY-M-D`
  - `YYYY/M/D`
  - `YYYY.M.D`
  - 月、日自动补零（例如 `2024-1-2` → `20240102`）。
- 示例：
  - 输入：`随访于2024年1月2日` → `随访于20240102`
  - 输入：`入院 2019-12-31` → `入院20191231`

### 5) 电话号码等数字连接符
- 规则：去除数字之间的连字符或长破折号，不改变数字顺序。
- 示例：
  - 输入：`联系电话：138-0013-8000` → `联系电话13800138000`

### 6) 数学符号标准化
- 规则：将特殊数学符号转换为标准形式：
  - `≥` → `>=`，`≤` → `<=`，`≠` → `!=`
  - 保留：`±`、`∞`、`∑`、`∫`、`√`、`≈`
- 示例：
  - 输入：`血压≥140mmHg` → `血压>=140mmHg`

### 7) 科学计数法保护
- 规则：保护科学计数法格式，避免被错误处理
- 示例：
  - 输入：`11.5×10⁹/L` → 保持原样 `11.5×10⁹/L`

### 8) 页眉页脚清理
- 规则：移除简单页码格式：`第 X 页`、`Page X`。
- 示例：
  - 输入：`第 1 页` 或 `Page 2` → 从文本中移除。

### 9) 繁简转换
- 规则：使用OpenCC进行繁体字转简体字
- 示例：
  - 输入：`MRI（頭部）已檢，報告如下` → `MRI头部已检，报告如下`

### 10) 分句与标准化输出
- 规则：
  - 分句依据：`。！？；` 以及英文 `? ! ;` 与省略号（`…`/`...`）。
  - 每句内仅保留逗号（统一为中文逗号 `，`）；其他标点移除；去除空白。
  - 标准化阶段返回"单引号包裹的句子列表（字符串）"。
- 示例：
  - 输入：
    ```
    患者张某，男，45岁，主诉头痛3天。曾诊断为高血压，现服用降压药。医保卡号为12345678，进行MRI检查并开具电子处方。
    ```
  - 标准化输出：
    ```
    ['患者张某，男，45岁，主诉头痛3天', '曾诊断为高血压，现服用降压药', '医保卡号为12345678，进行MRI检查并开具电子处方']
    ```

---

## LTP分词规则与示例

### 1) 分词器配置
- **分词器**：LTP (Language Technology Platform)
- **任务**：仅执行中文分词（cws），不进行词性标注
- **处理方式**：直接使用LTP原始分词结果，目前无额外细分或术语匹配

### 2) 分词流程
- **输入**：标准化后的句子
- **处理**：`text_tools.ltp.pipeline([sentence], tasks=["cws"])`
- **清理**：移除空格、括号等字符：`re.sub(r'[\s()（）【】\[\]]', '', token)`
- **输出**：清理后的分词列表

### 3) 分词示例
- 输入句子：`患者张某，男，45岁，主诉头痛3天`
- LTP分词结果：`['患者', '张某', '，', '男', '，', '45', '岁', '，', '主诉', '头痛', '3', '天']`
- 最终输出：`['患者', '张某', '，', '男', '，', '45', '岁', '，', '主诉', '头痛', '3', '天']`

### 4) 特殊符号和单位处理
- **处理方式**：LTP直接分词，不进行特殊保护
- **示例**：
  - `mg/L` → `['mg', '/', 'L']`
  - `11.5×10⁹/L` → `['11.5×10⁹/L']`（通常作为整体保留）
  - `138/86mmHg` → `['138/86mmHg']`（血压值作为整体）

### 5) 完整分词输出格式
- **格式**：每个句子的分词结果用方括号包裹，多个句子连接
- **示例**：
  ```
  ['MRI', '头部', '已', '检', '，', '报告', '如下']['患者', '基本', '信息']['姓名', '张三']
  ```

---

## 技术实现详情

### 分词器状态
- **LTP**: ✅ 已启用，使用默认模型，仅执行中文分词任务
- **spaCy**: ❌ 已禁用，保留代码结构但不使用

### 完整处理流程
1. **文件解析** → 提取原始文本（支持.txt/.docx/.pdf）
2. **基础清理** → 移除HTML标签、噪音字符、页码
3. **字符标准化** → Unicode规范化、空白字符统一
4. **标点处理** → 重复标点清理、逗号统一
5. **数字处理** → 移除千分位逗号、连字符
6. **符号标准化** → 数学符号转换、科学计数法保护
7. **繁简转换** → OpenCC繁体转简体
8. **分句处理** → 按标点分句、句内标点清理
9. **日期标准化** → 统一为YYYYMMDD格式
10. **LTP分词** → 对每个句子进行中文分词
11. **结果清理** → 移除空格、括号等字符
12. **格式化输出** → 生成结构化文本字符串
13. **自动保存** → 保存到JSON文件
